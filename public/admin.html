<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Panel Admin - NightDreams</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      .logo-font { font-family: 'Orbitron', sans-serif; letter-spacing: 0.1em; font-weight: 500; }
      .card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
      .status-badge { font-size: 0.75em; padding: 0.25em 0.5em; }
      .user-actions { gap: 0.5rem; }
      .admin-stats { background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); }
      .token-display { font-family: 'Courier New', monospace; font-size: 0.8em; background: #f8f9fa; padding: 0.5rem; border-radius: 4px; word-break: break-all; }
      .modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
      .modal-header .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
      .form-check-label small { font-size: 0.8em; }
      .table th { background-color: #f8f9fa; font-weight: 600; }
      .badge { font-size: 0.8em; }

      /* --- iPhone/iOS style for accordion blocks --- */
      .accordion#adminAccordion {
        background: none;
      }
      .accordion#adminAccordion .accordion-item {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 2px 8px 0 rgba(0,0,0,0.07), 0 1px 2px 0 rgba(0,0,0,0.03);
        margin-bottom: 0.7rem;
        border: none;
        overflow: hidden;
        transition: box-shadow 0.2s;
      }
      .accordion#adminAccordion .accordion-item:active,
      .accordion#adminAccordion .accordion-item:focus-within {
        box-shadow: 0 8px 24px 0 rgba(0,0,0,0.13), 0 2px 8px 0 rgba(0,0,0,0.07);
      }
      .accordion#adminAccordion .accordion-header {
        border: none;
        background: none;
      }
      .accordion#adminAccordion .accordion-button {
        border: none;
        border-radius: 22px 22px 0 0;
        background: #f7f7fa;
        font-size: 1.13rem;
        font-weight: 500;
        color: #222;
        padding: 1.1rem 1.5rem;
        box-shadow: none;
        outline: none;
        transition: background 0.2s;
      }
      .accordion#adminAccordion .accordion-button:not(.collapsed) {
        background: #f0f4ff;
        color: #3a3a3a;
        box-shadow: none;
      }
      .accordion#adminAccordion .accordion-body {
        background: #fff;
        border-radius: 0 0 22px 22px;
        padding: 1.5rem 1.5rem 1.2rem 1.5rem;
      }
     @media (max-width: 600px) {
  input.form-control,
  select.form-select {
    font-size: 1rem;
    padding: 0.8rem 1rem;
  }
  .form-check-label {
    font-size: 1rem;
  }
}
      .form-check-label {
        font-size: 1rem;
      }




  .clubs-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1.2rem;
    justify-content: flex-start;
  }
  .club-card {
    flex: 1 1 calc(25% - 1.2rem); /* 4 cards per row, minus gap */
    max-width: 24%;
    min-width: 220px;
    box-sizing: border-box;
  }
  @media (max-width: 1200px) {
    .club-card { max-width: 32%; }
  }
  @media (max-width: 900px) {
    .club-card { max-width: 48%; }
  }
  @media (max-width: 600px) {
    .club-card { max-width: 100%; }
  }

  .day-block {
    background: linear-gradient(90deg, #6a82fb 0%, #fc5c7d 100%);
    color: #fff;
    border-radius: 14px;
    box-shadow: 0 2px 8px 0 rgba(106,130,251,0.08), 0 1px 2px 0 rgba(252,92,125,0.04);
    margin-bottom: 0.5rem;
    letter-spacing: 0.03em;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border: none;
  }
  .day-title {
    font-size: 1.18rem;
    font-weight: 600;
    text-shadow: 0 1px 4px rgba(0,0,0,0.08);
    letter-spacing: 0.04em;
  }
  .club-card {
    background: linear-gradient(135deg, #f8fafc 60%, #e0e7ff 100%);
    border-radius: 12px;
    box-shadow: 0 2px 8px 0 rgba(106,130,251,0.07), 0 1px 2px 0 rgba(252,92,125,0.03);
    min-width:220px;
    max-width:260px;
    padding: 1rem 1rem 0.7rem 1rem;
    margin-bottom: 0.5rem;
    transition: box-shadow 0.2s, transform 0.2s;
    border: 1px solid #e0e7ff;
  }
  .club-card:hover {
    box-shadow: 0 8px 24px 0 rgba(106,130,251,0.13), 0 2px 8px 0 rgba(252,92,125,0.07);
    transform: translateY(-2px) scale(1.03);
    border-color: #6a82fb;
  }
</style>
  <!-- Cache busting para scripts -->
  <script>
    // Función para recargar scripts con nueva versión
    function reloadScripts() {
      const version = Date.now();
      const scripts = document.querySelectorAll('script[src*="scripts/"], script[src*="js/"]');
      scripts.forEach(script => {
        const newScript = document.createElement('script');
        const src = script.src.split('?')[0]; // Remover parámetros existentes
        newScript.src = src + '?v=' + version;
        script.parentNode.replaceChild(newScript, script);
      });
    } // <-- Cierra reloadScripts correctamente
    
    // Detectar Ctrl+F5 para forzar recarga de scripts
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'F5') {
        e.preventDefault();
        reloadScripts();
        location.reload();
      }
    });
    
    // Función para limpiar caché manualmente de toda la aplicación
    async function limpiarCache() {
      if (confirm('¿Limpiar caché COMPLETO de toda la aplicación y recargar?\n\nEsto limpiará:\n- Caché del navegador\n- Service Worker\n- LocalStorage (excepto datos de sesión)\n- Caché de scripts')) {
        
        try {
          // 1. Limpiar Service Worker y sus cachés
          if ('serviceWorker' in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (const registration of registrations) {
              console.log('Eliminando Service Worker:', registration.scope);
              await registration.unregister();
            }
          }
          
          // 2. Limpiar todas las cachés del navegador
          if ('caches' in window) {
            const cacheNames = await caches.keys();
            for (const cacheName of cacheNames) {
              console.log('Eliminando caché:', cacheName);
              await caches.delete(cacheName);
            }
          }
          
          // 3. Preservar datos de sesión
          const currentAuth = localStorage.getItem('currentAuth');
          const userData = {
            nombre: localStorage.getItem('nombre'),
            correo: localStorage.getItem('correo'),
            rol: localStorage.getItem('rol'),
            estado: localStorage.getItem('estado'),
            isAdmin: localStorage.getItem('isAdmin'),
            permisos: localStorage.getItem('permisos')
          };
          
          // 4. Limpiar todo el localStorage
          localStorage.clear();
          sessionStorage.clear();
          
          // 5. Restaurar datos de sesión
          if (currentAuth) localStorage.setItem('currentAuth', currentAuth);
          if (userData.nombre) localStorage.setItem('nombre', userData.nombre);
          if (userData.correo) localStorage.setItem('correo', userData.correo);
          if (userData.rol) localStorage.setItem('rol', userData.rol);
          if (userData.estado) localStorage.setItem('estado', userData.estado);
          if (userData.isAdmin) localStorage.setItem('isAdmin', userData.isAdmin);
          if (userData.permisos) localStorage.setItem('permisos', userData.permisos);
          
          // 6. Limpiar variables globales de scripts
          delete window.db;
          delete window.messaging;
          delete window.enCola;
          delete window.confirmadas;
          delete window.rechazadas;
          delete window.currentFormData;
          delete window.pageState;
          delete window.formularioTimers;
          delete window.homeTimers;
          delete window.mesasTimers;
          
          // 7. Mensaje de éxito
          alert('✅ Caché completo limpiado exitosamente!\n\nLa aplicación se recargará ahora.');
          
          // 8. Recargar página con caché completamente limpio
          window.location.href = window.location.href + '?cache_cleared=' + Date.now();
          
        } catch (error) {
          console.error('Error limpiando caché:', error);
          alert('⚠️ Error al limpiar caché: ' + error.message + '\n\nSe recargará la página normalmente.');
          
          // Fallback: recarga normal
          reloadScripts();
          window.location.reload(true);
        }
      }
    }
    </script>
</head>
<body class="bg-light">
  <!-- Header -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand logo-font" href="index.html">
        <i data-lucide="shield-check" class="me-2"></i>
        NightDreams Admin
      </a>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-warning btn-sm" onclick="limpiarCache()">
          <i data-lucide="refresh-cw" class="me-1"></i>
          Limpiar Caché
        </button>
        <button class="btn btn-outline-light btn-sm" onclick="window.location.href='index.html'">
          <i data-lucide="arrow-left" class="me-1"></i>
          Volver a App
        </button>
      </div>
    </div>
  </nav>

  <div class="container mt-4">


    <!-- ACCORDION PRINCIPAL -->
    <div class="accordion" id="adminAccordion">
      <!-- Panel Admin de Usuarios (Token) -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingToken">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseToken" aria-expanded="true" aria-controls="collapseToken">
            <i data-lucide="key" class="me-2"></i> 🔔 Tu Token de Admin (Para notificaciones push)
          </button>
        </h2>
        <div id="collapseToken" class="accordion-collapse collapse show" aria-labelledby="headingToken" data-bs-parent="#adminAccordion">
          <div class="accordion-body">
            <div class="mb-3">
              <label class="form-label">Token actual:</label>
              <div id="adminTokenDisplay" class="token-display">
                <span class="text-muted">Presiona el botón para obtener tu token...</span>
              </div>
            </div>
            <button id="getTokenBtn" class="btn btn-primary me-2">
              <i data-lucide="refresh-ccw" class="me-1"></i>
              Obtener Token
            </button>
            <button id="copyTokenBtn" class="btn btn-outline-secondary">
              <i data-lucide="copy" class="me-1"></i>
               Copiar Token
            </button>
          </div>
        </div>
      </div>

      <!-- Gestión de Productos -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingProductos">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProductos" aria-expanded="false" aria-controls="collapseProductos">
            <i data-lucide="package" class="me-2"></i> Catalogo NightDreams
          </button>
        </h2>
        <div id="collapseProductos" class="accordion-collapse collapse" aria-labelledby="headingProductos" data-bs-parent="#adminAccordion">
          <div class="accordion-body">
            <div class="mb-3">
              <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addProductoModal">
                <i data-lucide="plus" class="me-1"></i>
                Añadir Producto
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Sub-Productos</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="productosTable">
                  <tr>
                    <td colspan="3" class="text-center">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando productos...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Week Schedule -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingWeek">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseWeek" aria-expanded="false" aria-controls="collapseWeek">
            <i data-lucide="calendar-days" class="me-2"></i> Week Schedule
          </button>
        </h2>
        <div id="collapseWeek" class="accordion-collapse collapse" aria-labelledby="headingWeek" data-bs-parent="#adminAccordion">
          <div class="accordion-body">
            <div class="table-responsive">
              <table class="table table-striped align-middle">
                <thead>
                  <tr>
                  
                
                  </tr>
                </thead>
                <tbody id="weekScheduleTable">
                  <tr>
                    <td colspan="3" class="text-center">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando horarios...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Gestión de Usuarios -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingUsuarios">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUsuarios" aria-expanded="false" aria-controls="collapseUsuarios">
            <i data-lucide="users" class="me-2"></i> Gestión de Usuarios
          </button>
        </h2>
        <div id="collapseUsuarios" class="accordion-collapse collapse" aria-labelledby="headingUsuarios" data-bs-parent="#adminAccordion">
          <div class="accordion-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>Fecha Registro</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="usuariosTable">
                  <tr>
                    <td colspan="6" class="text-center">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando usuarios...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

     

    <!-- Modal para agregar nuevo producto -->
    <div class="modal fade" id="addProductoModal" tabindex="-1" aria-labelledby="addProductoModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addProductoModalLabel">
              <i data-lucide="plus-circle" class="me-2"></i>
              Añadir Producto
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="addProductoForm">
              <div class="mb-3">
                <label for="productoNombre" class="form-label">Nombre del Producto *</label>
                <input type="text" class="form-control" id="productoNombre" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Sub-Productos</label>
                <div id="subProductosList"></div>
                <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addSubProductoBtn">
                  <i data-lucide="plus"></i> Añadir Sub-Producto
                </button>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-success" id="saveProductoBtn">
              <i data-lucide="save" class="me-1"></i>
              Guardar Producto
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL PARA AÑADIR CLUB/PRODUCTO A UN DÍA (CATÁLOGO) -->
    <div class="modal fade" id="addCatalogModal" tabindex="-1" aria-labelledby="addCatalogModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addCatalogModalLabel">
              <i data-lucide="plus-circle" class="me-2"></i>
              Añadir Club/Producto al Día
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="addCatalogForm">
              <div class="mb-3">
                <label for="catalogProducto" class="form-label">Club/Producto *</label>
                <select class="form-select" id="catalogProducto" required>
                  <option value="">Selecciona un club/producto</option>
                </select>
                <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addCatalogProductoBtn">
                  <i data-lucide="plus"></i> Añadir Nuevo Producto
                </button>
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="catalogDrink" checked>
                  <label class="form-check-label" for="catalogDrink">
                    <strong>Drink incluido</strong>
                  </label>
                </div>
              </div>
              <div class="mb-3">
                <label for="catalogPrecio" class="form-label">Precio</label>
                <input type="number" class="form-control" id="catalogPrecio" min="0" step="0.01" placeholder="Ej: 20">
              </div>
              <div class="mb-3">
                <label for="catalogHora" class="form-label">Horario</label>
                <input type="text" class="form-control" id="catalogHora" placeholder="Ej: 23:00">
              </div>
              <div class="mb-3">
                <label for="catalogOtro" class="form-label">Otro (opcional)</label>
                <input type="text" class="form-control" id="catalogOtro" placeholder="Observaciones">
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="catalogFullTicket" checked>
                    <label class="form-check-label" for="catalogFullTicket">
                      Full Ticket
                    </label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="catalogPreSale" checked>
                    <label class="form-check-label" for="catalogPreSale">
                      Pre-Sale
                    </label>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-success" id="saveCatalogBtn">
              <i data-lucide="save" class="me-1"></i>
              Guardar
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-messaging-compat.js"></script>

  <!-- Firebase Configuration (fetch from server for security) -->
  <script>
const VAPID_KEY = 'BJklec5TmcAlNhPnCeyTRbDV44eDLHH-pTWcSRFYZw0E6RZI4PG6vbijPmnZcrkUDzc2z365GEksr8rNX8lePdo';

async function initializeFirebase() {
  try {
    const firebaseConfig = {
  apiKey           : 'AIzaSyAojJehdlYbQjfpjaDPCh-59y0rZG-fM34',
  authDomain       : 'nightdreams-f90b0.firebaseapp.com',
  projectId        : 'nightdreams-f90b0',
  storageBucket    : 'nightdreams-f90b0.appspot.com',             // ✔ dominio corregido
  messagingSenderId: '1011859565794',
  appId            : '1:1011859565794:web:f9a5faa6ea2a10f47202bb',
  measurementId    : 'G-NHMYKW05DT'
};

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

    window.auth = firebase.auth();
    window.db = firebase.firestore();
    window.messaging = firebase.messaging.isSupported() ? firebase.messaging() : null;

    auth.onAuthStateChanged(async (user) => {
      if (!user) return (window.location.href = "access.html");

      const userDoc = await db.collection('usuarios').doc(user.uid).get();

    if (!userDoc.exists) {
      console.log('[AUTH] Usuario no existe en Firestore');
      return { acceso: false, motivo: 'usuario_no_existe' };
    }
    
    const userData = userDoc.data();
    console.log('[AUTH] Datos usuario:', userData);
    
    // Verificar si es admin (email especial o rol admin)
    const isAdmin = userData.correo === 'official.nightdreams@gmail.com' || 
                   userData.rol === 'admin' || 
                   userData.rol === 'Admin';
    
    if (isAdmin) {
  console.log('[AUTH] Usuario es admin, acceso concedido');
  await loadAdminData();
  return;
}
    });
    
  } catch (error) {
    console.error('[AUTH] Error verificando acceso:', error);
    return { acceso: false, motivo: 'error_verificacion' };
  }
}

// Llama a loadWeekSchedule() al cargar admin
async function loadAdminData() {
  try {
    showLoader(true);
    await Promise.all([loadUsuarios(), loadWeekSchedule()]);
    lucide?.createIcons?.();
  } catch (err) {
    console.error("Error cargando datos admin:", err);
  } finally {
    showLoader(false);
  }
}

async function getAdminToken() {
  try {
    if (!messaging) throw new Error("Firebase Messaging no compatible");

    const permission = await Notification.requestPermission();
    if (permission !== 'granted') return alert('Permiso de notificación denegado');

    const token = await messaging.getToken({ vapidKey: VAPID_KEY });

    document.getElementById('adminTokenDisplay').textContent = token;
    console.log('🔔 TOKEN DE ADMIN:', token);

    const user = auth.currentUser;
    if (user) {
      await db.collection('usuarios').doc(user.uid).update({
        tokenPush: token,
        ultimoTokenUpdate: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    alert('Token obtenido y guardado. Copia desde la consola (F12).');
  } catch (error) {
    console.error("❌ Error obteniendo token:", error);
    document.getElementById('adminTokenDisplay').textContent = 'Error obteniendo token';
  }
}

async function loadUsuarios() {
  try {
    const snapshot = await db.collection('usuarios').orderBy('fechaRegistro', 'desc').get();
    const usuarios = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    displayUsuarios(usuarios);
  } catch (err) {
    console.error("Error cargando usuarios:", err);
    document.getElementById('usuariosTable').innerHTML = errorRow('usuarios');
  }
}

function displayUsuarios(lista) {
  const table = document.getElementById('usuariosTable');
  if (lista.length === 0) {
    table.innerHTML = emptyRow('usuarios');
    return;
  }

  table.innerHTML = lista.map(u => {
    const fecha = u.fechaRegistro ? new Date(u.fechaRegistro.seconds * 1000).toLocaleDateString() : 'N/A';
    const badgeRol = `<span class="badge bg-info">${u.rol || 'N/A'}</span>`;
    const badgeEstado = `<span class="badge ${estadoColor(u.estado)}">${u.estado || 'N/A'}</span>`;
    const btnToken = u.tokenPush
      ? `<button class="btn btn-outline-primary btn-sm" onclick="navigator.clipboard.writeText('${u.tokenPush}').then(()=>alert('Token copiado!'))"><i data-lucide="copy"></i> Token</button>`
      : '';
    return `
      <tr>
        <td>${u.nombre || 'N/A'}</td>
        <td>${u.correo || 'N/A'}</td>
        <td>${badgeRol}</td>
        <td>${badgeEstado}</td>
        <td>${fecha}</td>
        <td>
          <div class="d-flex gap-1">
            ${accionesUsuario(u)}
            ${btnToken}
          </div>
        </td>
      </tr>
    `;
  }).join('');
  lucide?.createIcons?.();
}

function accionesUsuario(u) {
  const botones = [];
  if (u.estado === 'Pendiente') {
    botones.push(btnAprobar(u.id), btnRechazar(u.id));
  } else if (u.estado === 'Rechazado') {
    botones.push(btnAprobar(u.id));
  }
  if (u.rol !== 'Admin') {
    botones.push(btnEliminar(u.id));
  }
  return botones.join('');
}

const btnAprobar = id => `<button class="btn btn-sm btn-success" onclick="changeUserStatus('${id}', 'Aprobado')"><i data-lucide="check"></i></button>`;
const btnRechazar = id => `<button class="btn btn-sm btn-danger" onclick="changeUserStatus('${id}', 'Rechazado')"><i data-lucide="x"></i></button>`;
const btnEliminar = id => `<button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${id}')"><i data-lucide="trash-2"></i></button>`;
const estadoColor = estado => ({
  'Aprobado': 'bg-success',
  'Pendiente': 'bg-warning text-dark',
  'Rechazado': 'bg-danger'
}[estado] || 'bg-secondary');

async function changeUserStatus(id, nuevoEstado) {
  try {
    await db.collection('usuarios').doc(id).update({
      estado: nuevoEstado,
      ultimaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
    });
    await loadUsuarios();
    alert(`Usuario ${nuevoEstado.toLowerCase()} exitosamente`);
  } catch (err) {
    console.error("Error al cambiar estado:", err);
    alert("No se pudo actualizar el estado");
  }
}

async function deleteUser(id) {
  try {
    await db.collection('usuarios').doc(id).delete();
    await loadUsuarios();
    alert("Usuario eliminado correctamente");
  } catch (err) {
    console.error("Error al eliminar:", err);
    alert("No se pudo eliminar");
  }
}

const WEEK_DAYS_ORDER = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

// Utilidad para generar ID limpio para inputs
const fieldId = (diaId, club, field) => `${diaId}_${club}_${field}`.replace(/\s+/g, '_');

// Guardar campo individualmente
window.saveClubField = async function(diaId, club, field, value) {
  try {
    const ref = db.collection('WeekDays').doc(diaId);
    const updateData = {};
    updateData[`clubs.${club}.${field}`] = field === 'precio' ? parseFloat(value) : value;
    await ref.update(updateData);
    console.log(`✅ Campo '${field}' actualizado para ${club} (${diaId})`);
  } catch (err) {
    alert('Error al actualizar campo');
    console.error(err);
  }
};

// Botón opcional para notificar cambios
window.notificarCambioPrecio = async function(diaId, club) {
  try {
    const doc = await db.collection('WeekDays').doc(diaId).get();
    if (!doc.exists) return alert("No se encontró el día");

    const clubData = doc.data().clubs?.[club];
    if (!clubData) return alert("No se encontró el club");

    const msg = `📢 ${club} (${diaId})\n🕒 ${clubData.hora || '-'}\n💸 ${clubData.precio || '-'}`;
    if (!confirm(`¿Enviar notificación?\n\n${msg}`)) return;

    await db.collection('notificaciones').add({
      titulo: `Cambio en ${club}`,
      cuerpo: msg,
      tipo: 'precio',
      enviadoPor: localStorage.getItem('nombre') || 'admin',
      creadoEn: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert('✅ Notificación enviada');
  } catch (err) {
    alert('Error al enviar notificación');
    console.error(err);
  }
};

// Función principal de renderizado en tiempo real
function renderWeekSchedule(docs) {
  const table = document.getElementById('weekScheduleTable');
  let html = '';
  WEEK_DAYS_ORDER.forEach(dia => {
    const data = docs[dia] || {};
    html += `<tr><td colspan="100%" class="day-block fw-bold py-2" style="font-size:1.15rem;">
      <span class="day-title">${dia.charAt(0).toUpperCase() + dia.slice(1)}</span>
      <button class="btn btn-sm btn-outline-light ms-2" onclick="showAddClubModal('${data.id || dia}')">
        <i data-lucide="plus"></i> Añadir Club
      </button>
    </td></tr>`;
    const clubs = Object.entries(data.clubs || {});
    if (clubs.length > 0) {
      html += '<tr><td colspan="100%"><div class="clubs-row">';
      clubs.forEach(([club, val]) => {
        html += `<div class="club-card">
            <strong>${club}</strong>
            <div class="mt-2">
              <div class="mb-2">
                <label class="form-label mb-0">💲 Precio</label>
                <input type="number" class="form-control form-control-sm" id="${fieldId(data.id, club, 'precio')}"
                  value="${val.precio || ''}" onchange="saveClubField('${data.id}', '${club}', 'precio', this.value)">
              </div>
              <div class="mb-2">
                <label class="form-label mb-0">🕒 Hora</label>
                <input type="text" class="form-control form-control-sm" id="${fieldId(data.id, club, 'hora')}"
                  value="${val.hora || ''}" onchange="saveClubField('${data.id}', '${club}', 'hora', this.value)">
              </div>
              <div class="mb-2">
                <label class="form-label mb-0">🔤 Otro</label>
                <input type="text" class="form-control form-control-sm" id="${fieldId(data.id, club, 'otro')}"
                  value="${val.otro || ''}" onchange="saveClubField('${data.id}', '${club}', 'otro', this.value)">
              </div>
              <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="${fieldId(data.id, club, 'drink')}" ${val.drink ? 'checked' : ''}
                  onchange="saveClubField('${data.id}', '${club}', 'drink', this.checked)">
                <label class="form-check-label">Drink incluido</label>
              </div>
              <button class="btn btn-outline-warning btn-sm me-2" onclick="notificarCambioPrecio('${data.id}','${club}')">
                <i data-lucide="megaphone"></i> Notificar cambio
              </button>
              <button class="btn btn-outline-danger btn-sm" onclick="removeClubFromDay('${data.id}','${club}')">
                <i data-lucide="trash-2"></i> Eliminar
              </button>
            </div>
          </div>`;
      });
      html += '</div></td></tr>';
    } else {
      html += `<tr><td colspan="100%"><span class="text-muted">Sin clubs asignados</span></td></tr>`;
    }
  });
  table.innerHTML = html;
  lucide?.createIcons?.();
}

// Activar sincronización en tiempo real con onSnapshot
function loadWeekSchedule() {
  db.collection('WeekDays').onSnapshot(snap => {
    const docs = {};
    snap.forEach(doc => {
      docs[doc.id.toLowerCase()] = { id: doc.id, ...doc.data() };
    });
    renderWeekSchedule(docs);
  });
}


// Modal para añadir club a un día
function showAddClubModal(diaId) {
  window._catalogDiaId = diaId;
  cargarCatalogoProductos();
  bootstrap.Modal.getOrCreateInstance(document.getElementById('addCatalogModal')).show();
}

async function cargarCatalogoProductos() {
  const select = document.getElementById('catalogProducto');
  select.innerHTML = '<option value="">Selecciona un club/producto</option>';
  try {
    const snapshot = await db.collection('Productos').get();
    snapshot.forEach(doc => {
      const nombre = doc.data().nombre || doc.id;
      select.innerHTML += `<option value="${nombre}">${nombre}</option>`;
    });
  } catch (err) {
    select.innerHTML += '<option value="">Error cargando productos</option>';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  initializeFirebase();

  // Iconos Lucide para toda la página
  setTimeout(() => {
    lucide?.createIcons?.();
  }, 300);

  // Botones de token
  const btnToken = document.getElementById('getTokenBtn');
  const btnCopiar = document.getElementById('copyTokenBtn');
  if (btnToken) btnToken.addEventListener('click', getAdminToken);
  if (btnCopiar) {
    btnCopiar.addEventListener('click', () => {
      const token = (document.getElementById('adminTokenDisplay').textContent || '').trim();
      if (token && !token.includes('Error')) {
        navigator.clipboard.writeText(token)
          .then(() => alert('Token copiado al portapapeles'))
          .catch(() => alert('No se pudo copiar. Copia manualmente desde consola.'));
      } else {
        alert('Primero obtén el token');
      }
    });
  }

  // Botón añadir producto desde modal catálogo
  const addCatalogProductoBtn = document.getElementById('addCatalogProductoBtn');
  if (addCatalogProductoBtn) {
    addCatalogProductoBtn.onclick = function() {
      // Cierra el modal catálogo y abre el modal de producto
      bootstrap.Modal.getOrCreateInstance(document.getElementById('addCatalogModal')).hide();
      document.getElementById('addProductoForm').reset();
      document.getElementById('subProductosList').innerHTML = '';
      bootstrap.Modal.getOrCreateInstance(document.getElementById('addProductoModal')).show();
    };
  }

  // Botón guardar producto desde modal
  // Modal Sub-Productos
let subProductos = {};
function renderSubProductos() {
  const list = document.getElementById('subProductosList');
  list.innerHTML = Object.keys(subProductos).length === 0
    ? '<span class="text-muted">Sin sub-productos</span>'
    : Object.entries(subProductos).map(([k,v]) => `
      <div class="input-group mb-2">
        <input type="text" class="form-control form-control-sm" value="${k}" readonly>
        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeSubProducto('${k}')"><i data-lucide='trash-2'></i></button>
      </div>`).join('');
  lucide?.createIcons?.();
}
window.removeSubProducto = function(k) {
  delete subProductos[k];
  renderSubProductos();
}
document.getElementById('addSubProductoBtn').addEventListener('click', function() {
  const nombre = prompt('Nombre del sub-producto:');
  if (nombre && !subProductos[nombre]) {
    subProductos[nombre] = true;
    renderSubProductos();
  }
});

document.getElementById('saveProductoBtn').addEventListener('click', async function() {
  const nombre = document.getElementById('productoNombre').value.trim();
  if (!nombre) return alert('El nombre es obligatorio');
  try {
    await db.collection('Productos').add({ nombre, subProductos });
    subProductos = {};
    document.getElementById('addProductoForm').reset();
    renderSubProductos();
    bootstrap.Modal.getOrCreateInstance(document.getElementById('addProductoModal')).hide();
    await loadProductos();
    alert('Producto guardado');
  } catch (err) {
    alert('Error guardando producto');
    console.error(err);
  }
});

  // Botón cancelar producto desde modal
  const cancelProductoBtn = document.querySelector('#addProductoModal .btn-secondary');
  if (cancelProductoBtn) {
    cancelProductoBtn.onclick = function() {
      bootstrap.Modal.getOrCreateInstance(document.getElementById('addProductoModal')).hide();
    };
  }

  // Botón guardar catálogo
  const saveCatalogBtn = document.getElementById('saveCatalogBtn');
  if (saveCatalogBtn) {
    saveCatalogBtn.onclick = async function() {
      const diaId = window._catalogDiaId;
      const club = document.getElementById('catalogProducto').value;
      const drink = document.getElementById('catalogDrink').checked;
      const precio = document.getElementById('catalogPrecio').value;
      const hora = document.getElementById('catalogHora').value;
      const otro = document.getElementById('catalogOtro').value;
      const fullTicket = document.getElementById('catalogFullTicket').checked;
      const preSale = document.getElementById('catalogPreSale').checked;
      if (!club) return alert('Selecciona un club/producto');
      const data = { drink, precio, hora, otro, fullTicket, preSale };
      await addClubToDay(diaId, club, data);
      bootstrap.Modal.getOrCreateInstance(document.getElementById('addCatalogModal')).hide();
    };
  }

  // Cargar productos al iniciar para el panel de productos
  loadProductos();
});

// --- Loader para el admin ---
function showLoader(show) {
  // Puedes implementar un overlay o spinner global si lo deseas
  // Por defecto, no hace nada
}

// --- Productos Firestore CRUD ---
async function loadProductos() {
  try {
    const snapshot = await db.collection('Productos').get();
    const productos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    displayProductos(productos);
  } catch (err) {
    console.error('Error cargando productos:', err);
    document.getElementById('productosTable').innerHTML = '<tr><td colspan="3" class="text-center text-danger">Error cargando productos</td></tr>';
  }
}

function displayProductos(lista) {
  const table = document.getElementById('productosTable');
  if (lista.length === 0) {
    table.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No hay productos</td></tr>';
    return;
  }
  table.innerHTML = lista.map(p => {
    const subProds = p.subProductos ? Object.keys(p.subProductos).map(k => `<span class='badge bg-info me-1'>${k}</span>`).join('') : '<span class="text-muted">N/A</span>';
    return `<tr>
      <td><strong>${p.nombre || 'N/A'}</strong></td>
      <td>${subProds}</td>
      <td><!-- Acciones futuras --></td>
    </tr>`;
  }).join('');
  lucide?.createIcons?.();
}

// --- Añadir club/producto a un día en WeekDays ---
async function addClubToDay(diaId, club, data) {
  try {
    const ref = db.collection('WeekDays').doc(diaId);
    const doc = await ref.get();
    let clubs = {};
    if (doc.exists && doc.data().clubs) {
      clubs = doc.data().clubs;
    }
    clubs[club] = data;
    await ref.set({ clubs }, { merge: true });
    await loadWeekSchedule();
    alert('Club/producto añadido exitosamente');
  } catch (err) {
    console.error('Error añadiendo club/producto:', err);
    alert('No se pudo añadir el club/producto');
  }
}

// --- Eliminar club/producto de un día en WeekDays ---
async function removeClubFromDay(diaId, club) {
  try {
    const ref = db.collection('WeekDays').doc(diaId);
    await ref.update({ [`clubs.${club}`]: firebase.firestore.FieldValue.delete() });
    await loadWeekSchedule();
  } catch (err) {
    alert('Error eliminando club');
    console.error(err);
  }
}

</script>
</body>
</html>
