<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>NightDreams – Acceso</title>
  <link rel="manifest" href="manifest.json" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
  <style>
    .logo-font { font-family: 'Orbitron', sans-serif; letter-spacing: 0.1em; font-weight: 500; text-transform: uppercase; }
    input.form-control { border-radius: 12px; padding: 12px 16px; font-size: 1rem; background-color: #f9f9f9; border: 1px solid #ccc; }
    .card { border-radius: 24px; padding: 30px 25px; }
    .btn-dark { border-radius: 14px; font-weight: bold; font-size: 1rem; padding: 10px; }
    .pwa-banner { background: #fff3cd; color: #856404; padding: 1em; border-radius: 16px; text-align: center; font-weight: bold; }
    .hide { display: none !important; }
    .small { font-size: 0.97em; }
    
    /* Deshabilitar gestos de navegación en móviles */
    html, body {
      overscroll-behavior-x: none;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y pinch-zoom;
    }
    
    /* Deshabilitar swipe back en iOS Safari */
    body {
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: contain;
    }
    /* Solo deshabilitar selección en botones para accesibilidad */
    button, .btn {
      -webkit-user-select: none;
      user-select: none;
    }
  </style>

  <!-- Firebase SDK from CDN -->
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-messaging-compat.js"></script>

  <!-- Firebase Configuration -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAojJehdlYbQjfpjaDPCh-59y0rZG-fM34",
      authDomain: "nightdreams-f90b0.firebaseapp.com",
      projectId: "nightdreams-f90b0",
      storageBucket: "nightdreams-f90b0.appspot.com",
      messagingSenderId: "1011859565794",
      appId: "1:1011859565794:web:f9a5faa6ea2a10f47202bb",
      measurementId: "G-NHMYKW05DT"
    };
    
    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // Inicializar Firebase Messaging
    let messaging = null;
    if (firebase.messaging.isSupported()) {
      messaging = firebase.messaging();
    }

  </script>
</head>
<body class="bg-light d-flex align-items-center justify-content-center vh-100">
  <div class="container px-4">
    <div class="card shadow text-center">
      <div class="mb-4">
        <img src="icon-192.png" class="mb-3" width="72" height="72">
        <h2 class="logo-font mb-0">NightDreams</h2>
        <p class="text-muted small" style="margin-top: -5px;">Team registración</p>
      </div>
      <div id="pwaBanner" class="pwa-banner mb-3 hide">
        <span>Para registrarte, <b>añade NightDreams a la pantalla de inicio</b>.<br>¡Instala la app y vuelve aquí!</span><br>
        <button id="btnInstall" class="btn btn-warning mt-2">Instalar App</button>
        <div class="mt-1 text-muted" style="font-size:0.95em">
          <b>Android:</b> Menú (⋮) > "Agregar a pantalla de inicio"<br>
          <b>iOS:</b> Compartir (⬆) > "Añadir a pantalla de inicio"
        </div>
      </div>
      <form id="registroForm" class="text-start hide">
        <div class="mb-3">
          <input type="text" class="form-control" id="nombre" placeholder="Nombre completo" required>
        </div>
        <div class="mb-3">
          <input type="email" class="form-control" id="correo" placeholder="Correo electrónico" required>
        </div>
        <div class="mb-3">
          <input type="password" class="form-control" id="password" placeholder="Contraseña (mínimo 6 caracteres)" required minlength="6">
          <div class="form-text">
            <small class="text-muted">
              <strong>Admin:</strong> official.nightdreams@gmail.com tendrá permisos completos automáticamente
            </small>
          </div>
        </div>
        <button type="submit" class="btn btn-dark w-100">Registrarse / Acceder</button>
      </form>
            <div id="resultado" class="mt-3 text-start"></div>
      <div id="cargando" class="mt-3 alert alert-info">Cargando...</div>
    </div>
  </div>

  
<script>
   document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('registroForm');
      const resultado = document.getElementById('resultado');
      const cargandoDiv = document.getElementById('cargando');
      const pwaBanner = document.getElementById('pwaBanner');
      const btnInstall = document.getElementById('btnInstall');
      
      let deferredPrompt;

      function isStandaloneMode() {
        return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
      }
      
      function showBanner() {
  pwaBanner.classList.remove('hide');   // ← mostrar
  form.classList.add('hide');           // ocultar el formulario
  cargandoDiv.classList.add('hide');
}
      
      function showForm() {
        pwaBanner.classList.add('hide');
        form.classList.remove('hide');
        cargandoDiv.classList.add('hide');
      }
      
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        showBanner();
        btnInstall.onclick = async () => {
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          location.reload();
        };
      });

      // El listener del formulario se define una sola vez.
      form.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const submitBtn = ev.target.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  resultado.innerHTML = '<div class="alert alert-secondary">Procesando…</div>';

  const nombre   = document.getElementById('nombre').value.trim();
  const email    = document.getElementById('correo').value.trim().toLowerCase();
  const password = document.getElementById('password').value;

  let cred;
  let esNuevo = false;

  try {
    // 1. Registro → si el correo ya existe pasamos al login
    try {
      cred = await auth.createUserWithEmailAndPassword(email, password);
      esNuevo = true;
      await cred.user.updateProfile({ displayName: nombre });
    } catch (err) {
      if (err.code === 'auth/email-already-in-use') {
        cred = await auth.signInWithEmailAndPassword(email, password);
      } else {
        throw err;
      }
    }

    // 2. Documento Firestore solo si es nuevo
    const uid = cred.user.uid;
    const ref = db.collection('usuarios').doc(uid);
    if (esNuevo) {
      await ref.set({
        uid,
        nombre,
        correo : email,
        rol    : 'promotor',
        estado : 'Pendiente',
        fechaRegistro: firebase.firestore.FieldValue.serverTimestamp(),
        permisos: {
          admin     : false,
          eliminar  : false,
          modificar : true,
          ver_todo  : false
        }
      });
    }

    // 3. Decide destino
    const snap = await ref.get();
    const destino = (snap.exists && snap.data().estado === 'Aprobado')
        ? 'index.html'
        : 'espera.html';

    resultado.innerHTML =
      '<div class="alert alert-success">¡Bienvenido! Redirigiendo…</div>';
    setTimeout(() => location.replace(destino), 1200);

  } catch (err) {
  submitBtn.disabled = false;

  if (err.code === 'auth/wrong-password') {
    resultado.innerHTML = '<div class="alert alert-danger">Contraseña incorrecta.</div>';
  } else if (err.code === 'auth/user-not-found') {
    resultado.innerHTML = '<div class="alert alert-danger">Correo no registrado.</div>';
  } else {
    resultado.innerHTML = `<div class="alert alert-danger">❌ ${err.message}</div>`;
  }

    console.error('[AUTH ERROR]', err);
  }
});

      // Asegurarse de que Firebase Auth está listo antes de mostrar el formulario.
      auth.onAuthStateChanged(user => {
        // Esta función se ejecuta cuando el estado de autenticación está listo.
        // Ahora podemos decidir si mostrar el banner PWA o el formulario de registro.
        if (!isStandaloneMode()) {
          showBanner();
        } else {
          showForm();
        }
      });
});
</script>

</body>
</html>

